<script>

/* ========================== AUTENTICAÇÃO ========================== */
/**
 * Módulo de Autenticação - Gerenciamento de Login e Senhas
 * 
 * Responsabilidades:
 * - Fazer login no sistema
 * - Recuperar senha esquecida
 * - Alterar senha
 * - Fazer logout
 * - Validar credenciais
 * 
 * RPC Calls:
 * - loginUsuario(usuario, senha)
 * - recuperarSenha(email)
 * - alterarSenha(usuario, senhaAtual, novaSenha)
 * 
 * State Management:
 * - Estado.usuarioAtual
 * - Estado.isAdmin
 * - Estado.senhaTemporaria
 */

/**
 * Realiza login no sistema
 * Valida credenciais, salva cookie se "Lembrar-me", e redireciona
 */
function fazerLogin() {
  const usuario = (document.getElementById("usuarioLogin")?.value || "").trim();
  const senha = (document.getElementById("senhaLogin")?.value || "").trim();
  const msg = document.getElementById("msgLogin");
  
  if (msg) msg.textContent = "";
  
  if (!usuario || !senha) {
    if (msg) msg.textContent = "Preencha todos os campos.";
    return;
  }

  const lembrar = document.getElementById("lembrarMe")?.checked;
  
  // Salva preferência de "lembrar-me"
  try {
    if (lembrar) {
      localStorage.setItem("lembrarMe", "1");
      localStorage.setItem("usuario", usuario);
    } else {
      localStorage.removeItem("lembrarMe");
      localStorage.removeItem("usuario");
    }
  } catch(_) {}

  Loading.show("Autenticando...");
  
  google.script.run
    .withSuccessHandler((res) => {
      Loading.hide();
      
      if (res && res.status === "ok") {
        // Salva dados do usuário no Estado
        Estado.usuarioAtual = res.usuario;
        Estado.isAdmin = res.perfil === "admin";
        Estado.senhaTemporaria = res.senhaTemporaria || false;

        salvarSessao({
          usuario: res.usuario,
          login: res.login || usuario,
          nome: res.nome || usuario,
          perfil: res.perfil || (Estado.isAdmin ? "admin" : "user"),
          senhaTemporaria: Estado.senhaTemporaria
        });
        
        // Adiciona classe ao body se for admin
        if (Estado.isAdmin) {
          document.body.classList.add("is-admin");
        }
        
        // Atualiza nome do usuário na sidebar
        const nomeSidebar = document.getElementById("nomeUsuarioSidebar");
        const perfilUsuario = document.getElementById("perfilUsuario");
        
        if (nomeSidebar) nomeSidebar.textContent = res.nome || usuario;
        if (perfilUsuario) perfilUsuario.textContent = Estado.isAdmin ? "Administrador" : "Operador";
        
        if (res.senhaPadrao || Estado.senhaTemporaria) {
          // Força alteração de senha
          const usuarioAlterar = document.getElementById("usuarioAlterar");
          if (usuarioAlterar) usuarioAlterar.value = res.login || usuario;
          alternarTelaDeNivelSuperior("telaAlterarSenha");
        } else {
          // Login bem sucedido
          alternarTelaDeNivelSuperior("app");
          mostrarTelaDashboard();
          mostrarToast(`Bem-vindo, ${res.nome || usuario}!`, "success");
          // Atualiza notificações de tickets
          if (typeof atualizarNotificacoesTickets === "function") {
            atualizarNotificacoesTickets();
          }
          iniciarMonitorSessao();
        }
      } else {
        if (msg) msg.textContent = res?.msg || "Usuário ou senha inválidos.";
        mostrarToast(res?.msg || "Falha no login.", "error");
      }
    })
    .withFailureHandler((err) => {
      Loading.hide();
      if (msg) msg.textContent = "Erro ao fazer login!";
      console.error(err);
      mostrarToast("Erro ao fazer login!", "error");
    })
    .loginUsuario(usuario, senha);
}

// ====================== SESSÃO ======================
const TEMPO_SESSAO_MS = 8 * 60 * 60 * 1000; // 8 horas

function salvarSessao(info) {
  const sessao = {
    ...info,
    lastAt: Date.now()
  };
  Cookies.set("sessao", sessao, 1); // cookie 1 dia, controlamos expiração via lastAt
  try {
    localStorage.setItem("sessao", JSON.stringify(sessao));
  } catch(_) {}
}

function touchSessao() {
  const s = Cookies.get("sessao");
  if (s) {
    s.lastAt = Date.now();
    Cookies.set("sessao", s, 1);
    try { localStorage.setItem("sessao", JSON.stringify(s)); } catch(_) {}
    return;
  }
  try {
    const ls = JSON.parse(localStorage.getItem("sessao") || "null");
    if (ls) {
      ls.lastAt = Date.now();
      localStorage.setItem("sessao", JSON.stringify(ls));
    }
  } catch(_) {}
}

function limparSessao() {
  Cookies.delete("sessao");
  try { localStorage.removeItem("sessao"); } catch(_) {}
}

function restaurarSessao() {
  let s = Cookies.get("sessao");
  if (!s) {
    try { s = JSON.parse(localStorage.getItem("sessao") || "null"); } catch(_) {}
  }
  if (!s || !s.lastAt) return false;
  const agora = Date.now();
  if ((agora - s.lastAt) > TEMPO_SESSAO_MS) {
    limparSessao();
    return false;
  }

  Estado.usuarioAtual = s.usuario || s.login || null;
  Estado.isAdmin = s.perfil === "admin";
  Estado.senhaTemporaria = !!s.senhaTemporaria;

  if (Estado.isAdmin) {
    document.body.classList.add("is-admin");
  }

  const nomeSidebar = document.getElementById("nomeUsuarioSidebar");
  const perfilUsuario = document.getElementById("perfilUsuario");
  if (nomeSidebar) nomeSidebar.textContent = s.nome || s.login || "";
  if (perfilUsuario) perfilUsuario.textContent = Estado.isAdmin ? "Administrador" : "Operador";

  if (Estado.senhaTemporaria) {
    const usuarioAlterar = document.getElementById("usuarioAlterar");
    if (usuarioAlterar) usuarioAlterar.value = s.login || "";
    alternarTelaDeNivelSuperior("telaAlterarSenha");
  } else {
    alternarTelaDeNivelSuperior("app");
    mostrarTelaDashboard();
    if (typeof atualizarNotificacoesTickets === "function") {
      atualizarNotificacoesTickets();
    }
  }

  touchSessao();
  iniciarMonitorSessao();
  return true;
}

function iniciarMonitorSessao() {
  if (window._sessaoTimer) clearInterval(window._sessaoTimer);
  window._sessaoTimer = setInterval(() => {
    const s = Cookies.get("sessao");
    if (!s || !s.lastAt) return;
    const agora = Date.now();
    if ((agora - s.lastAt) > TEMPO_SESSAO_MS) {
      mostrarToast("Sessão expirada. Faça login novamente.", "warning");
      confirmarSaida();
    }
  }, 5 * 60 * 1000);
}

/**
 * Mostra a tela de recuperação de senha
 */
function mostrarEsqueciSenha() {
  alternarTelaDeNivelSuperior("telaEsqueciSenha");
}

/**
 * Volta para a tela de login, limpa mensagens
 */
function voltarLogin() {
  alternarTelaDeNivelSuperior("telaLogin");
  
  // Limpa mensagens de erro
  const msgs = ["msgLogin", "msgRecuperacao", "msgAlterar"];
  msgs.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.textContent = "";
  });
}

/**
 * Envia email de recuperação de senha
 */
function enviarRecuperacao() {
  const email = (document.getElementById("emailRecuperacao")?.value || "").trim();
  const msg = document.getElementById("msgRecuperacao");
  
  if (msg) msg.textContent = "";
  
  if (!email) {
    if (msg) msg.textContent = "Informe o email cadastrado.";
    return;
  }

  Loading.show("Enviando email...");
  
  google.script.run
    .withSuccessHandler((res) => {
      Loading.hide();
      const texto = res?.msg || "Email enviado com sucesso!";
      if (msg) {
        msg.textContent = texto;
        msg.style.color = res?.status === "ok" ? "green" : "red";
      }
      mostrarToast(texto, res?.status === "ok" ? "success" : "error");
      
      if (res?.status === "ok") {
        // Marca que pode usar senha temporária
        Estado.senhaTemporaria = true;
        setTimeout(() => voltarLogin(), 3000);
      }
    })
    .withFailureHandler((err) => {
      Loading.hide();
      if (msg) msg.textContent = "Erro ao enviar email!";
      console.error(err);
      mostrarToast("Erro ao enviar email!", "error");
    })
    .recuperarSenha(email);
}

/**
 * Altera a senha do usuário
 * Valida força de senha e confirmação
 */
function alterarSenha() {
  const usuario = (document.getElementById("usuarioAlterar")?.value || "").trim();
  const senhaAtual = (document.getElementById("senhaAtual")?.value || "").trim();
  const novaSenha = (document.getElementById("novaSenha")?.value || "").trim();
  const confirmarSenha = (document.getElementById("confirmarSenha")?.value || "").trim();
  const msg = document.getElementById("msgAlterar");
  
  if (msg) msg.textContent = "";
  
  if (!usuario || !senhaAtual || !novaSenha || !confirmarSenha) {
    if (msg) msg.textContent = "Preencha todos os campos.";
    return;
  }
  
  if (novaSenha !== confirmarSenha) {
    if (msg) msg.textContent = "As senhas não coincidem.";
    return;
  }
  
  if (novaSenha.length < 6) {
    if (msg) msg.textContent = "A senha deve ter no mínimo 6 caracteres.";
    return;
  }

  Loading.show("Alterando senha...");
  
  google.script.run
    .withSuccessHandler((res) => {
      Loading.hide();
      const texto = res?.msg || "Senha alterada.";
      if (msg) {
        msg.textContent = texto;
        msg.style.color = res?.status === "ok" ? "green" : "red";
      }
      mostrarToast(texto, res?.status === "ok" ? "success" : "error");
      
      if (res?.status === "ok") {
        Estado.senhaTemporaria = false;
        setTimeout(() => {
          alternarTelaDeNivelSuperior("app");
          mostrarTelaDashboard();
        }, 1500);
      }
    })
    .withFailureHandler((err) => {
      Loading.hide();
      if (msg) msg.textContent = "Erro ao alterar senha!";
      console.error(err);
      mostrarToast("Erro ao alterar senha!", "error");
    })
    .alterarSenha(usuario, senhaAtual, novaSenha);
}

/**
 * Abre modal de confirmação de logout
 */
function confirmarLogout() {
  mostrarConfirmacao(
    "Deseja realmente sair do sistema?",
    "Confirmar saída",
    "Sim, sair",
    "Não"
  ).then((ok) => {
    if (ok) confirmarSaida();
  });
}

/**
 * Realiza logout - limpa cookies, estado e retorna ao login
 */
function confirmarSaida() {
  // Limpa todos os cookies
  Cookies.limparTodos();
  limparSessao();
  
  // Limpa estado
  Estado.usuarioAtual = null;
  Estado.isAdmin = false;
  Estado.dadosOriginais = [];
  Estado.dadosFiltrados = [];
  Estado.dashboardCache = null;
  
  document.body.classList.remove("is-admin");
  if (window._notifTimer) {
    clearInterval(window._notifTimer);
    window._notifTimer = null;
  }
  if (window._sessaoTimer) {
    clearInterval(window._sessaoTimer);
    window._sessaoTimer = null;
  }
  alternarTelaDeNivelSuperior("telaLogin");
  mostrarToast("Logout realizado com sucesso!", "info");
}


</script>
