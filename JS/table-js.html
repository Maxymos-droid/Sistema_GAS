
<script>

/* ========================== TABELAS E PAGINAÇÃO ========================== */
/**
 * Módulo de Tabelas - Renderização e Controle de Paginação
 * 
 * Responsabilidades:
 * - Render da tabela com paginação
 * - Controles de navegação (anterior, próximo, páginas)
 * - Detalhes expandíveis de registros
 * - Edição de registros em modal
 * - Exportação para Excel
 * - Formatação de datas
 * 
 * Funções principais:
 * - renderizarTabelaPaginada() - Renderiza com paginação
 * - atualizarPaginacao() - Muda linhas por página
 * - exportarParaExcel() - Exporta dados filtrados
 */

// ========== UTILIDADES ==========
/**
 * Formata data ISO para DD/MM/YYYY
 * @param {string} dataStr - Data em formato ISO ou string
 * @returns {string} - Data formatada
 */
function formatarDataISO(dataStr) {
  if (!dataStr) return "";
  const data = new Date(dataStr);
  if (isNaN(data)) return dataStr;
  
  const dia = String(data.getDate()).padStart(2, "0");
  const mes = String(data.getMonth() + 1).padStart(2, "0");
  const ano = data.getFullYear();
  return `${dia}/${mes}/${ano}`;
}

/**
 * Converte data de yyyy-mm-dd para DD/MM/YYYY
 * @param {string} dataStr - Data em formato de input
 * @returns {string} - Data formatada
 */
function converterDataParaInput(dataStr) {
  if (!dataStr) return "";
  // Converte dd/mm/yyyy para yyyy-mm-dd
  const partes = dataStr.split('/');
  if (partes.length === 3) {
    return `${partes[2]}-${partes[1]}-${partes[0]}`;
  }
  return dataStr;
}

// ========== PAGINAÇÃO ==========
/**
 * Atualiza o número de linhas por página
 * Carrega nova página e rerendera
 */
function atualizarPaginacao() {
  const sel = document.getElementById("linhasPorPagina");
  Estado.linhasPorPagina = parseInt(sel?.value || "10", 10);
  Estado.paginaAtual = 1;
  renderizarTabelaPaginada();
}

/**
 * Renderiza a tabela com paginação aplicada
 * Calcula offset baseado em página e linhas por página
 */
function renderizarTabelaPaginada() {
  const dados = Estado.dadosFiltrados;
  const cabecalho = dados[0] || [];
  const linhas = dados.length > 1 ? dados.slice(1) : [];
  
  const totalPaginas = Math.max(1, Math.ceil(linhas.length / Estado.linhasPorPagina));
  if (Estado.paginaAtual > totalPaginas) Estado.paginaAtual = totalPaginas;
  
  const inicio = (Estado.paginaAtual - 1) * Estado.linhasPorPagina;
  const fim = inicio + Estado.linhasPorPagina;
  const linhasPagina = linhas.slice(inicio, fim);
  
  renderizarTabela([cabecalho, ...linhasPagina]);
  renderizarControlesPaginacao(totalPaginas);
}

// ========== RENDERIZAÇÃO DA TABELA ==========
/**
 * Renderiza a tabela HTML com linhas e colunas
 * @param {Array[]} dados - Array da primeira linha (cabeçalho) + linhas
 */
function renderizarTabela(dados) {
  const tabela = document.getElementById("dadosTabela");
  if (!tabela) return;
  
  const thead = tabela.querySelector("thead");
  const tbody = tabela.querySelector("tbody");
  
  if (thead) thead.innerHTML = "";
  if (tbody) tbody.innerHTML = "";
  
  if (!dados || !dados.length) {
    if (tbody) tbody.innerHTML = "<tr><td colspan='100%' style='text-align:center; padding:40px;'>Nenhum dado encontrado</td></tr>";
    return;
  }
  
  const cabecalho = dados[0];
  const colunasResumo = [
    "ID", "DACTE", "CAVALO", "REMETENTE", "DESTINATARIO",
    "UF/CIDADE DEST", "NOTA FISCAL", "ENTREGADOR", "STATUS"
  ];
  
  // Larguras fixas para cada coluna
  const larguras = {
    "ID": "60px",
    "DACTE": "100px",
    "CAVALO": "100px",
    "REMETENTE": "150px",
    "DESTINATARIO": "150px",
    "UF/CIDADE DEST": "120px",
    "NOTA FISCAL": "120px",
    "ENTREGADOR": "120px",
    "STATUS": "150px"
  };
  
  // Renderiza cabeçalho
  if (thead) {
    thead.innerHTML = `
      <tr>
        <th style="width: 80px; text-align: center;">Ações</th>
        ${colunasResumo.map(c => `
          <th style="width: ${larguras[c] || '120px'};">
            <div style="display: flex; align-items: center; gap: 8px;">
              ${c}
              <i class="material-symbols-outlined filter-icon"
                 onclick="filtrarColuna('${c}', event)" title="Filtrar">filter_alt</i>
            </div>
          </th>
        `).join("")}
      </tr>
    `;
  }
  
  // Renderiza linhas
  for (let i = 1; i < dados.length; i++) {
    const linha = dados[i];
    const obj = {};
    cabecalho.forEach((col, idx) => obj[col] = linha[idx]);
    
    const idxLinha = (Estado.paginaAtual - 1) * Estado.linhasPorPagina + (i - 1);
    
    const rowHTML = `
      <tr ondblclick="abrirModalEdicao(${idxLinha})">
        <td style="text-align: center; width: 80px;">
          <i class="material-symbols-outlined btn-action" onclick="toggleDetalhes(${idxLinha}); event.stopPropagation();" 
             id="btn${idxLinha}" 
             style="color:#28a745; cursor:pointer; font-size:20px;" 
             title="Expandir">add_circle</i>
          <i class="material-symbols-outlined btn-action" onclick="abrirModalEdicao(${idxLinha}); event.stopPropagation();" 
             style="color:#007bff; cursor:pointer; font-size:20px; margin-left:4px;" 
             title="Editar">edit</i>
        </td>
        ${colunasResumo.map(c => {
          let valor = obj[c] ?? "";
          
          // Formatação de datas
          if (c.toUpperCase().includes("DATA")) {
            valor = formatarDataISO(valor);
          }
          
          const largura = larguras[c] || '120px';
          
          return `<td style="max-width: ${largura}; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${valor}">${valor}</td>`;
        }).join("")}
      </tr>
    `;
    
    // Renderiza linha de detalhes (expandível)
    const colunasDetalhe = cabecalho.filter(c => !colunasResumo.includes(c));
    
    const detalheHTML = `
      <tr id="detalhes${idxLinha}" style="display:none; background:#f8f9fa;">
        <td colspan="${colunasResumo.length + 1}" style="padding:20px !important;">
          <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap:12px;">
            ${colunasDetalhe.map(c => {
              let val = obj[c] ?? "";
              if (c.toUpperCase().includes("DATA")) {
                val = formatarDataISO(val);
              }
              return `<div><strong>${c}:</strong> ${val}</div>`;
            }).join("")}
          </div>
        </td>
      </tr>
    `;
    
    if (tbody) tbody.insertAdjacentHTML("beforeend", rowHTML + detalheHTML);
  }
}

/**
 * Alterna visibilidade da linha de detalhes
 * @param {number} idx - Índice da linha
 */
function toggleDetalhes(idx) {
  const detalhe = document.getElementById(`detalhes${idx}`);
  const btn = document.getElementById(`btn${idx}`);
  
  if (!detalhe || !btn) return;
  
  const visivel = detalhe.style.display === "table-row";
  detalhe.style.display = visivel ? "none" : "table-row";
  btn.textContent = visivel ? "add_circle" : "remove_circle";
  btn.style.color = visivel ? "#28a745" : "#dc3545";
  btn.title = visivel ? "Expandir" : "Recolher";
}

// ========== EDIÇÃO DE REGISTROS ==========
/**
 * Abre modal de edição de registro
 * Preenche campos com dados atuais
 * @param {number} idx - Índice da linha nos dados filtrados
 */
function abrirModalEdicao(idx) {
  const linha = Estado.dadosFiltrados[idx + 1];
  const cabecalho = Estado.dadosFiltrados[0];
  
  if (!linha || !cabecalho) return;
  
  Estado.registroEditando = { idx, linha, cabecalho };
  
  const modal = document.getElementById('modalEditarRegistro');
  const corpo = document.getElementById('corpoModalRegistro');
  
  if (!modal || !corpo) return;
  
  // Gera formulário com os campos
  let html = '<div class="form-edit-grid">';
  
  cabecalho.forEach((col, i) => {
    const valor = linha[i] || "";
    const isData = col.toUpperCase().includes("DATA");
    const isObservacao = col.toUpperCase() === "OBSERVAÇÃO";
    
    html += `
      <div class="form-group ${isObservacao ? 'full-width' : ''}">
        <label>${col}</label>
        ${isObservacao 
          ? `<textarea class="form-control" id="campo_${i}" rows="3">${valor}</textarea>`
          : `<input type="${isData ? 'date' : 'text'}" class="form-control" id="campo_${i}" value="${isData ? converterDataParaInput(valor) : valor}" />`
        }
      </div>
    `;
  });
  
  html += '</div>';
  corpo.innerHTML = html;
  modal.classList.add('show');
}

/**
 * Fecha o modal de edição
 */
function fecharModalRegistro() {
  document.getElementById('modalEditarRegistro').classList.remove('show');
  Estado.registroEditando = null;
}

/**
 * Salva as alterações do registro editado
 */
function salvarRegistro() {
  if (!Estado.registroEditando) return;
  
  const { idx, cabecalho } = Estado.registroEditando;
  const novosValores = [];
  
  cabecalho.forEach((col, i) => {
    const campo = document.getElementById(`campo_${i}`);
    if (campo) {
      let valor = campo.value;
      // Se for data, converte de volta
      if (col.toUpperCase().includes("DATA") && valor) {
        const partes = valor.split('-');
        if (partes.length === 3) {
          valor = `${partes[2]}/${partes[1]}/${partes[0]}`;
        }
      }
      novosValores.push(valor);
    }
  });
  
  // Atualiza no estado local
  Estado.dadosFiltrados[idx + 1] = novosValores;
  
  // TODO: Salvar no backend via RPC
  // google.script.run.salvarRegistro(idRegistro, novosValores);
  
  renderizarTabelaPaginada();
  fecharModalRegistro();
  mostrarToast("Registro atualizado com sucesso!", "success");
}

/**
 * Abre modal para adicionar novo registro
 */
function abrirModalNovo() {
  const modal = document.getElementById('modalEditarRegistro');
  const titulo = document.getElementById('tituloModalRegistro');
  const corpo = document.getElementById('corpoModalRegistro');
  
  if (!modal || !corpo) {
    mostrarToast("Modal não encontrado", "error");
    return;
  }
  
  if (titulo) titulo.textContent = "Novo Registro";
  
  const cabecalho = Estado.dadosFiltrados[0] || [];
  
  if (cabecalho.length === 0) {
    mostrarToast("Carregue os dados primeiro", "warning");
    return;
  }
  
  Estado.registroEditando = { idx: -1, linha: [], cabecalho };
  
  // Gera formulário vazio
  let html = '<div class="form-edit-grid">';
  
  cabecalho.forEach((col, i) => {
    const isData = col.toUpperCase().includes("DATA");
    const isObservacao = col.toUpperCase() === "OBSERVAÇÃO";
    
    html += `
      <div class="form-group ${isObservacao ? 'full-width' : ''}">
        <label>${col}</label>
        ${isObservacao 
          ? `<textarea class="form-control" id="campo_${i}" rows="3"></textarea>`
          : `<input type="${isData ? 'date' : 'text'}" class="form-control" id="campo_${i}" value="" />`
        }
      </div>
    `;
  });
  
  html += '</div>';
  corpo.innerHTML = html;
  modal.classList.add('show');
}

// ========== CONTROLES DE PAGINAÇÃO ==========
/**
 * Renderiza os controles de paginação (anterior, números, próximo)
 * @param {number} totalPaginas - Total de páginas
 */
function renderizarControlesPaginacao(totalPaginas) {
  const wrap = document.getElementById("paginacao");
  if (!wrap) return;
  
  wrap.innerHTML = "";
  const ul = document.createElement("ul");
  ul.className = "paginacao-list";
  
  // Botão Anterior
  const liPrev = document.createElement("li");
  liPrev.innerHTML = `<i class="material-symbols-outlined">arrow_back</i>`;
  if (Estado.paginaAtual === 1) {
    liPrev.setAttribute('disabled', 'true');
  }
  liPrev.onclick = () => {
    if (Estado.paginaAtual > 1) {
      Estado.paginaAtual--;
      renderizarTabelaPaginada();
    }
  };
  ul.appendChild(liPrev);
  
  // Números de página
  const maxExibir = 7;
  let inicio = Math.max(1, Estado.paginaAtual - Math.floor(maxExibir / 2));
  let fim = Math.min(totalPaginas, inicio + maxExibir - 1);
  
  if (fim - inicio < maxExibir - 1) {
    inicio = Math.max(1, fim - maxExibir + 1);
  }
  
  for (let i = inicio; i <= fim; i++) {
    const li = document.createElement("li");
    li.textContent = i;
    if (i === Estado.paginaAtual) li.classList.add("ativo");
    li.onclick = () => {
      Estado.paginaAtual = i;
      renderizarTabelaPaginada();
    };
    ul.appendChild(li);
  }
  
  // Botão Próximo
  const liNext = document.createElement("li");
  liNext.innerHTML = `<i class="material-symbols-outlined">arrow_forward</i>`;
  if (Estado.paginaAtual === totalPaginas) {
    liNext.setAttribute('disabled', 'true');
  }
  liNext.onclick = () => {
    if (Estado.paginaAtual < totalPaginas) {
      Estado.paginaAtual++;
      renderizarTabelaPaginada();
    }
  };
  ul.appendChild(liNext);
  
  wrap.appendChild(ul);
}

// ========== EXPORTAÇÃO ==========
/**
 * Exporta os dados filtrados para arquivo Excel
 * Requer ChartJS ou biblioteca similar de XLSX
 */
function exportarParaExcel() {
  if (!window.XLSX) {
    mostrarToast("Biblioteca de exportação não carregada", "error");
    return;
  }
  
  const dados = Estado.dadosFiltrados;
  if (!dados || dados.length === 0) {
    mostrarToast("Nenhum dado para exportar", "warning");
    return;
  }
  
  // Cria workbook
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(dados);
  
  XLSX.utils.book_append_sheet(wb, ws, "Entregas");
  
  // Gera arquivo
  const dataAtual = new Date().toISOString().split('T')[0];
  XLSX.writeFile(wb, `entregas_${dataAtual}.xlsx`);
  
  mostrarToast("Arquivo exportado com sucesso!", "success");
}

// ========== FILTROS POR COLUNA ==========
function filtrarColuna(nomeColuna, ev) {
  if (!Estado.filtrosColuna) Estado.filtrosColuna = {};
  const painelId = "painelFiltroColuna";
  const antigo = document.getElementById(painelId);
  if (antigo) antigo.remove();

  const dadosBase = (Estado.dadosFiltrados && Estado.dadosFiltrados.length)
    ? Estado.dadosFiltrados
    : Estado.dadosOriginais;
  const cabecalho = dadosBase[0] || [];
  const idxCol = cabecalho.indexOf(nomeColuna);
  if (idxCol < 0) {
    mostrarToast(`Coluna "${nomeColuna}" não encontrada`, "error");
    return;
  }

  const valores = dadosBase.slice(1).map(l => String(l[idxCol] ?? "").trim());
  const unicos = Array.from(new Set(valores)).sort((a, b) => a.localeCompare(b, 'pt-BR'));
  const selecionados = new Set(Estado.filtrosColuna[nomeColuna] || unicos);

  const painel = document.createElement("div");
  painel.id = painelId;
  painel.className = "filter-panel";
  painel.style.position = "absolute";
  painel.style.zIndex = "9999";
  painel.style.background = "#fff";
  painel.style.border = "1px solid #dee2e6";
  painel.style.boxShadow = "0 8px 24px rgba(0,0,0,0.12)";
  painel.style.borderRadius = "10px";
  painel.style.padding = "12px";
  painel.style.minWidth = "220px";
  painel.style.maxWidth = "320px";
  painel.style.maxHeight = "360px";
  painel.style.display = "flex";
  painel.style.flexDirection = "column";

  const rect = ev?.target?.getBoundingClientRect();
  if (rect) {
    painel.style.top = `${rect.bottom + window.scrollY + 6}px`;
    painel.style.left = `${rect.left + window.scrollX - 20}px`;
  } else {
    painel.style.top = "120px";
    painel.style.left = "120px";
  }

  const header = document.createElement("div");
  header.style.display = "flex";
  header.style.justifyContent = "space-between";
  header.style.alignItems = "center";
  header.style.marginBottom = "8px";
  header.innerHTML = `<strong>${nomeColuna}</strong>`;
  painel.appendChild(header);

  const actions = document.createElement("div");
  actions.className = "filter-actions";
  actions.style.display = "flex";
  actions.style.flexWrap = "wrap";
  actions.style.gap = "8px";
  actions.style.marginBottom = "8px";
  actions.innerHTML = `
    <a href="#" id="lnkAz" class="filter-link">A-Z</a>
    <a href="#" id="lnkZa" class="filter-link">Z-A</a>
    <a href="#" id="lnkNumAsc" class="filter-link">0-9</a>
    <a href="#" id="lnkNumDesc" class="filter-link">9-0</a>
  `;
  painel.appendChild(actions);

  const search = document.createElement("input");
  search.type = "text";
  search.placeholder = "Pesquisar...";
  search.className = "form-control filter-search";
  search.style.marginBottom = "8px";
  painel.appendChild(search);

  const selectAllWrap = document.createElement("label");
  selectAllWrap.className = "filter-select-all";
  selectAllWrap.style.display = "flex";
  selectAllWrap.style.gap = "8px";
  selectAllWrap.style.alignItems = "center";
  selectAllWrap.style.marginBottom = "8px";
  selectAllWrap.innerHTML = `
    <input type="checkbox" id="chkAll" />
    <span>Selecionar todos</span>
  `;
  painel.appendChild(selectAllWrap);

  const lista = document.createElement("div");
  lista.className = "filter-list";
  lista.style.display = "flex";
  lista.style.flexDirection = "column";
  lista.style.gap = "6px";
  lista.style.overflow = "auto";
  lista.style.paddingBottom = "8px";
  lista.style.maxHeight = "200px";

  unicos.forEach((val, i) => {
    const id = `chk_${i}_${nomeColuna}`;
    const wrap = document.createElement("label");
    wrap.style.display = "flex";
    wrap.style.gap = "8px";
    wrap.style.alignItems = "center";
    wrap.innerHTML = `
      <input type="checkbox" id="${id}" data-valor="${val}" />
      <span>${val || "(vazio)"}</span>
    `;
    const chk = wrap.querySelector("input");
    if (selecionados.has(val)) chk.checked = true;
    lista.appendChild(wrap);
  });

  painel.appendChild(lista);

  const footer = document.createElement("div");
  footer.className = "filter-footer";
  footer.style.display = "flex";
  footer.style.gap = "8px";
  footer.style.marginTop = "10px";
  footer.innerHTML = `
    <button class="btn-sm btn-primary" type="button" id="btnAplicar">Aplicar</button>
    <button class="btn-sm btn-secondary" type="button" id="btnLimpar">Limpar</button>
  `;
  painel.appendChild(footer);

  document.body.appendChild(painel);

  const chkAll = painel.querySelector("#chkAll");
  const chks = Array.from(painel.querySelectorAll('input[type="checkbox"][data-valor]'));
  const atualizarChkAll = () => {
    chkAll.checked = chks.every(c => c.checked);
  };
  atualizarChkAll();
  chkAll.addEventListener("change", () => {
    chks.forEach(c => { c.checked = chkAll.checked; });
  });
  chks.forEach(c => c.addEventListener("change", atualizarChkAll));

  painel.querySelector("#lnkAz").onclick = (e) => {
    e.preventDefault();
    e.stopPropagation();
    ordenarPorColuna(nomeColuna, "asc");
  };
  painel.querySelector("#lnkZa").onclick = (e) => {
    e.preventDefault();
    e.stopPropagation();
    ordenarPorColuna(nomeColuna, "desc");
  };
  painel.querySelector("#lnkNumAsc").onclick = (e) => {
    e.preventDefault();
    e.stopPropagation();
    ordenarPorColuna(nomeColuna, "num-asc");
  };
  painel.querySelector("#lnkNumDesc").onclick = (e) => {
    e.preventDefault();
    e.stopPropagation();
    ordenarPorColuna(nomeColuna, "num-desc");
  };
  painel.querySelector("#btnAplicar").onclick = (e) => {
    e.stopPropagation();
    const selecionadosNovos = chks.filter(c => c.checked).map(c => c.dataset.valor);
    if (selecionadosNovos.length === 0) {
      Estado.filtrosColuna[nomeColuna] = [];
    } else {
      Estado.filtrosColuna[nomeColuna] = selecionadosNovos;
    }
    aplicarFiltrosColuna();
    painel.remove();
  };
  painel.querySelector("#btnLimpar").onclick = (e) => {
    e.stopPropagation();
    delete Estado.filtrosColuna[nomeColuna];
    aplicarFiltrosColuna();
    painel.remove();
  };

  const onClickFora = (e) => {
    if (!painel.contains(e.target)) {
      painel.remove();
      document.removeEventListener("click", onClickFora);
    }
  };
  setTimeout(() => document.addEventListener("click", onClickFora), 0);

  // Filtro de busca nos itens
  search.addEventListener("input", () => {
    const termoBusca = search.value.toLowerCase();
    const labels = Array.from(lista.querySelectorAll("label"));
    labels.forEach(l => {
      const txt = l.textContent.toLowerCase();
      l.style.display = txt.includes(termoBusca) ? "flex" : "none";
    });
  });
}

function aplicarFiltrosColuna() {
  const orig = Estado.dadosOriginais || [];
  const cabecalho = orig[0] || [];
  let linhas = orig.slice(1);

  const filtros = Estado.filtrosColuna || {};
  Object.keys(filtros).forEach(col => {
    const idx = cabecalho.indexOf(col);
    if (idx < 0) return;
    const valores = filtros[col];
    if (!Array.isArray(valores) || valores.length === 0) return;
    const set = new Set(valores.map(v => String(v)));
    linhas = linhas.filter(l => set.has(String(l[idx] ?? "")));
  });

  Estado.dadosFiltrados = [cabecalho, ...linhas];
  Estado.paginaAtual = 1;
  renderizarTabelaPaginada();
  if (typeof atualizarContagemTabela === "function") {
    atualizarContagemTabela();
  }
}

function ordenarPorColuna(nomeColuna, direcao = "asc") {
  const dados = Estado.dadosFiltrados || Estado.dadosOriginais || [];
  if (dados.length <= 1) return;
  const cabecalho = dados[0];
  const idx = cabecalho.indexOf(nomeColuna);
  if (idx < 0) return;

  const linhas = dados.slice(1);
  linhas.sort((a, b) => {
    const va = a[idx];
    const vb = b[idx];
    let cmp = 0;
    if (direcao === "num-asc" || direcao === "num-desc") {
      const na = Number(String(va).replace(/[^\d.-]/g, ""));
      const nb = Number(String(vb).replace(/[^\d.-]/g, ""));
      cmp = (isNaN(na) ? 0 : na) - (isNaN(nb) ? 0 : nb);
      return direcao === "num-desc" ? -cmp : cmp;
    }
    const na = Number(va);
    const nb = Number(vb);
    if (!Number.isNaN(na) && !Number.isNaN(nb)) {
      cmp = na - nb;
    } else {
      cmp = String(va ?? "").localeCompare(String(vb ?? ""), 'pt-BR');
    }
    return direcao === "desc" ? -cmp : cmp;
  });

  Estado.dadosFiltrados = [cabecalho, ...linhas];
  Estado.paginaAtual = 1;
  renderizarTabelaPaginada();
  if (typeof atualizarContagemTabela === "function") {
    atualizarContagemTabela();
  }
}

// ======= FILTRO PARA LISTAS (TICKETS / USUÁRIOS) =======
function filtrarColunaLista(contexto, nomeColuna, ev) {
  if (!window._filtrosLista) window._filtrosLista = {};
  const key = `${contexto}:${nomeColuna}`;
  const painelId = "painelFiltroColunaLista";
  const antigo = document.getElementById(painelId);
  if (antigo) antigo.remove();

  const dados = (contexto === "tickets") ? (window._ticketsLista || []) : (window._usuariosLista || []);
  const mapItem = (item) => {
    if (contexto === "tickets") {
      const codigo = formatarCodigoTicket(item, 0);
      return {
        "ID": item.id ?? "",
        "Ticket": codigo,
        "Tipo": item.tipo ?? "",
        "Assunto": item.assunto ?? "",
        "Prioridade": item.prioridade ?? "",
        "Usuário": item.usuario ?? "",
        "Status": item.status ?? "",
        "Data": formatarDataISO(item.data)
      };
    }
    return {
      "ID": item.id ?? "",
      "Nome": item.nome ?? "",
      "Login": item.login ?? "",
      "Email": item.email ?? "",
      "Perfil": item.perfil ?? "",
      "Status": item.status ?? ""
    };
  };

  const valores = dados.map(d => String(mapItem(d)[nomeColuna] ?? "").trim());
  const unicos = Array.from(new Set(valores)).sort((a, b) => a.localeCompare(b, 'pt-BR'));
  const selecionados = new Set((window._filtrosLista[key] || unicos).map(v => String(v)));

  const painel = document.createElement("div");
  painel.id = painelId;
  painel.className = "filter-panel";

  const rect = ev?.target?.getBoundingClientRect();
  if (rect) {
    painel.style.top = `${rect.bottom + window.scrollY + 6}px`;
    painel.style.left = `${rect.left + window.scrollX - 20}px`;
  } else {
    painel.style.top = "120px";
    painel.style.left = "120px";
  }

  const header = document.createElement("div");
  header.style.display = "flex";
  header.style.justifyContent = "space-between";
  header.style.alignItems = "center";
  header.style.marginBottom = "8px";
  header.innerHTML = `<strong>${nomeColuna}</strong>`;
  painel.appendChild(header);

  const actions = document.createElement("div");
  actions.className = "filter-actions";
  actions.innerHTML = `
    <a href="#" id="lnkAz" class="filter-link">A-Z</a>
    <a href="#" id="lnkZa" class="filter-link">Z-A</a>
    <a href="#" id="lnkNumAsc" class="filter-link">0-9</a>
    <a href="#" id="lnkNumDesc" class="filter-link">9-0</a>
  `;
  painel.appendChild(actions);

  const search = document.createElement("input");
  search.type = "text";
  search.placeholder = "Pesquisar...";
  search.className = "form-control filter-search";
  painel.appendChild(search);

  const selectAllWrap = document.createElement("label");
  selectAllWrap.className = "filter-select-all";
  selectAllWrap.innerHTML = `
    <input type="checkbox" id="chkAll" />
    <span>Selecionar todos</span>
  `;
  painel.appendChild(selectAllWrap);

  const lista = document.createElement("div");
  lista.className = "filter-list";

  unicos.forEach((val, i) => {
    const id = `chk_${i}_${nomeColuna}`;
    const wrap = document.createElement("label");
    wrap.innerHTML = `
      <input type="checkbox" id="${id}" data-valor="${val}" />
      <span>${val || "(vazio)"}</span>
    `;
    const chk = wrap.querySelector("input");
    if (selecionados.has(val)) chk.checked = true;
    lista.appendChild(wrap);
  });
  painel.appendChild(lista);

  const footer = document.createElement("div");
  footer.className = "filter-footer";
  footer.innerHTML = `
    <button class="btn-sm btn-primary" type="button" id="btnAplicar">Aplicar</button>
    <button class="btn-sm btn-secondary" type="button" id="btnLimpar">Limpar</button>
  `;
  painel.appendChild(footer);

  document.body.appendChild(painel);

  const chkAll = painel.querySelector("#chkAll");
  const chks = Array.from(painel.querySelectorAll('input[type="checkbox"][data-valor]'));
  const atualizarChkAll = () => { chkAll.checked = chks.every(c => c.checked); };
  atualizarChkAll();
  chkAll.addEventListener("change", () => { chks.forEach(c => { c.checked = chkAll.checked; }); });
  chks.forEach(c => c.addEventListener("change", atualizarChkAll));

  painel.querySelector("#lnkAz").onclick = (e) => { e.preventDefault(); ordenarLista(contexto, nomeColuna, "asc"); };
  painel.querySelector("#lnkZa").onclick = (e) => { e.preventDefault(); ordenarLista(contexto, nomeColuna, "desc"); };
  painel.querySelector("#lnkNumAsc").onclick = (e) => { e.preventDefault(); ordenarLista(contexto, nomeColuna, "num-asc"); };
  painel.querySelector("#lnkNumDesc").onclick = (e) => { e.preventDefault(); ordenarLista(contexto, nomeColuna, "num-desc"); };
  painel.querySelector("#btnAplicar").onclick = (e) => {
    e.stopPropagation();
    const selecionadosNovos = chks.filter(c => c.checked).map(c => c.dataset.valor);
    window._filtrosLista[key] = selecionadosNovos;
    aplicarFiltrosLista(contexto);
    painel.remove();
  };
  painel.querySelector("#btnLimpar").onclick = (e) => {
    e.stopPropagation();
    delete window._filtrosLista[key];
    aplicarFiltrosLista(contexto);
    painel.remove();
  };

  const onClickFora = (e) => {
    if (!painel.contains(e.target)) {
      painel.remove();
      document.removeEventListener("click", onClickFora);
    }
  };
  setTimeout(() => document.addEventListener("click", onClickFora), 0);

  search.addEventListener("input", () => {
    const termoBusca = search.value.toLowerCase();
    const labels = Array.from(lista.querySelectorAll("label"));
    labels.forEach(l => {
      const txt = l.textContent.toLowerCase();
      l.style.display = txt.includes(termoBusca) ? "flex" : "none";
    });
  });
}

function aplicarFiltrosLista(contexto) {
  const dadosOrig = (contexto === "tickets") ? (window._ticketsLista || []) : (window._usuariosLista || []);
  const filtros = window._filtrosLista || {};
  let lista = dadosOrig.slice();

  const mapItem = (item) => {
    if (contexto === "tickets") {
      return {
        "ID": item.id ?? "",
        "Ticket": formatarCodigoTicket(item, 0),
        "Tipo": item.tipo ?? "",
        "Assunto": item.assunto ?? "",
        "Prioridade": item.prioridade ?? "",
        "Usuário": item.usuario ?? "",
        "Status": item.status ?? "",
        "Data": formatarDataISO(item.data)
      };
    }
    return {
      "ID": item.id ?? "",
      "Nome": item.nome ?? "",
      "Login": item.login ?? "",
      "Email": item.email ?? "",
      "Perfil": item.perfil ?? "",
      "Status": item.status ?? ""
    };
  };

  Object.keys(filtros).forEach(k => {
    const [ctx, col] = k.split(":");
    if (ctx !== contexto) return;
    const valores = filtros[k] || [];
    if (!valores.length) return;
    const set = new Set(valores.map(v => String(v)));
    lista = lista.filter(item => set.has(String(mapItem(item)[col] ?? "")));
  });

  if (contexto === "tickets") {
    renderizarTickets(lista, 'todos', '');
  } else {
    renderizarUsuarios(lista);
  }
}

function ordenarLista(contexto, nomeColuna, direcao) {
  const dadosOrig = (contexto === "tickets") ? (window._ticketsLista || []) : (window._usuariosLista || []);
  const mapItem = (item) => {
    if (contexto === "tickets") {
      return {
        "ID": item.id ?? "",
        "Ticket": formatarCodigoTicket(item, 0),
        "Tipo": item.tipo ?? "",
        "Assunto": item.assunto ?? "",
        "Prioridade": item.prioridade ?? "",
        "Usuário": item.usuario ?? "",
        "Status": item.status ?? "",
        "Data": formatarDataISO(item.data)
      };
    }
    return {
      "ID": item.id ?? "",
      "Nome": item.nome ?? "",
      "Login": item.login ?? "",
      "Email": item.email ?? "",
      "Perfil": item.perfil ?? "",
      "Status": item.status ?? ""
    };
  };
  const lista = dadosOrig.slice();
  lista.sort((a, b) => {
    const va = mapItem(a)[nomeColuna];
    const vb = mapItem(b)[nomeColuna];
    if (direcao === "num-asc" || direcao === "num-desc") {
      const na = Number(String(va).replace(/[^\d.-]/g, ""));
      const nb = Number(String(vb).replace(/[^\d.-]/g, ""));
      const cmp = (isNaN(na) ? 0 : na) - (isNaN(nb) ? 0 : nb);
      return direcao === "num-desc" ? -cmp : cmp;
    }
    const cmp = String(va ?? "").localeCompare(String(vb ?? ""), 'pt-BR');
    return direcao === "desc" ? -cmp : cmp;
  });

  if (contexto === "tickets") {
    renderizarTickets(lista, 'todos', '');
  } else {
    renderizarUsuarios(lista);
  }
}

// ======= INJEÇÃO AUTOMÁTICA DE ÍCONES =======
function aplicarIconesFiltroTabela(contexto, tableId, colunas) {
  const tabela = document.getElementById(tableId);
  if (!tabela) return;
  const ths = tabela.querySelectorAll("thead th");
  ths.forEach(th => {
    const label = th.textContent.trim();
    if (!colunas.includes(label)) return;
    if (th.querySelector(".filter-icon")) return;
    th.innerHTML = "";
    const wrap = document.createElement("span");
    wrap.className = "th-filter";
    const span = document.createElement("span");
    span.textContent = label;
    const icon = document.createElement("i");
    icon.className = "material-symbols-outlined filter-icon";
    icon.textContent = "filter_alt";
    icon.title = "Filtrar";
    icon.onclick = (e) => filtrarColunaLista(contexto, label, e);
    wrap.appendChild(span);
    wrap.appendChild(icon);
    th.appendChild(wrap);
  });
}


</script>

