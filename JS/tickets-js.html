
<script>

/* ========================== SISTEMA DE TICKETS ========================== */
/**
 * Módulo de Tickets - Ocorrências e Sugestões
 * 
 * Responsabilidades:
 * - Listar tickets do usuário/admin
 * - Criar novo ticket (ocorrência/sugestão)
 * - Visualizar detalhes do ticket
 * - Adicionar comentários
 * - Alterar status (somente admin)
 * - Filtrar por status
 * 
 * RPC Calls:
 * - listarTickets(usuario, isAdmin)
 * - criarTicket(ticket)
 * - atualizarStatusTicket(id, novoStatus)
 * - listarComentariosTicket(ticketId)
 * - adicionarComentarioTicket(ticketId, comentario)
 * 
 * Estados de Ticket:
 * - aberto, andamento, resolvido, fechado
 * 
 * Prioridades:
 * - alta, media, baixa
 * 
 * Tipos:
 * - ocorrencia, sugestao
 */

/**
 * Carrega tickets do usuário/admin
 * RPC: listarTickets(usuario, isAdmin)
 * 
 * @param {string} filtro - Filtro por status ('todos', 'aberto', etc)
 */
function carregarTickets(filtro = 'todos', q = '') {
  Loading.show("Carregando tickets...");

  google.script.run
    .withSuccessHandler((tickets) => {
      Loading.hide();
      window._ticketsLista = Array.isArray(tickets) ? tickets : (tickets && Array.isArray(tickets.tickets) ? tickets.tickets : []);
      aplicarIconesFiltroTabela("tickets", "tabelaTickets", ["ID", "Ticket", "Tipo", "Assunto", "Prioridade", "Usuário", "Status", "Data"]);
      renderizarTickets(tickets, filtro, q);
      if (typeof touchSessao === "function") {
        touchSessao();
      }
    })
    .withFailureHandler((err) => {
      Loading.hide();
      console.error(err);
      const msg = err && err.message ? err.message : (typeof err === "string" ? err : "Erro ao carregar tickets.");
      mostrarToast(msg, "error");
    })
    .listarTickets(Estado.usuarioAtual, Estado.isAdmin);
}

/**
 * Atualiza badge de notificações de tickets pendentes
 */
function atualizarNotificacoesTickets() {
  const badge = document.getElementById("badgeNotificacoes");
  if (!badge) return;

  const lastViewed = obterUltimaNotificacaoTicketsLida();

  google.script.run
    .withSuccessHandler((tickets) => {
      const arrAll = Array.isArray(tickets) ? tickets : [];
      const pendentes = arrAll.filter(t => isTicketPendenteParaNotificacao(t));
      const pendentesNovos = pendentes.filter(t => {
        const ts = Date.parse(t.data || "") || 0;
        return ts > lastViewed;
      }).length;

      const ultimoId = obterUltimaNotificacaoSistemaLida();
      google.script.run
        .withSuccessHandler((qtdeSistema) => {
          const pendentesSistema = Number(qtdeSistema) || 0;
          const total = pendentesNovos + pendentesSistema;
          badge.textContent = String(total);
          badge.style.display = total > 0 ? "inline-flex" : "none";
        })
        .withFailureHandler(() => {
          badge.textContent = String(pendentesNovos);
          badge.style.display = pendentesNovos > 0 ? "inline-flex" : "none";
        })
        .contarNotificacoesSistema(ultimoId);
    })
    .withFailureHandler((err) => {
      console.error(err);
      badge.textContent = "0";
      badge.style.display = "none";
    })
    .listarTickets(Estado.usuarioAtual, Estado.isAdmin);
}

function obterUltimaNotificacaoTicketsLida() {
  try {
    const k = `notifTicketsUltimo_${Estado.usuarioAtual || 'anon'}`;
    return Number(localStorage.getItem(k) || "0");
  } catch(_) {
    return 0;
  }
}

function marcarNotificacoesTicketsLidas(ts) {
  try {
    const k = `notifTicketsUltimo_${Estado.usuarioAtual || 'anon'}`;
    localStorage.setItem(k, String(ts || 0));
  } catch(_) {}
}

function obterUltimaNotificacaoSistemaLida() {
  try {
    const k = `notifSistemaUltimo_${Estado.usuarioAtual || 'anon'}`;
    return Number(localStorage.getItem(k) || "0");
  } catch(_) {
    return 0;
  }
}

// tabs removidas

function marcarNotificacoesSistemaLidas(ultimoId) {
  try {
    const k = `notifSistemaUltimo_${Estado.usuarioAtual || 'anon'}`;
    localStorage.setItem(k, String(ultimoId || 0));
  } catch(_) {}
}

function abrirNotificacoes() {
  const modal = document.getElementById("modalNotificacoes");
  const lista = document.getElementById("listaNotificacoes");
  if (!modal || !lista) return;
  lista.innerHTML = "<p style='text-align:center; color:#6c757d;'>Carregando...</p>";
  modal.classList.add("show");

  google.script.run
    .withSuccessHandler((tickets) => {
      const arrAll = Array.isArray(tickets) ? tickets : [];
      const arr = arrAll.filter(t => isTicketPendenteParaNotificacao(t));
      const ticketHtml = arr.map(t => `
        <div class="notif-item" onclick="abrirTicketPorId('${t.id}')">
          <div class="notif-title">${formatarCodigoTicket(t, 0)} - ${formatarStatus(t.status)} - 
          <span class="notif-sub">${formatarDataISO(t.data)}</spa></div>
          <div style="margin-top:6px;">${t.ultimoComentario || t.descricao || ""}</div>
        </div>
      `).join("");

      google.script.run
        .withSuccessHandler((dados) => {
          const sys = Array.isArray(dados) ? dados : [];
          const sysHtml = sys.map(n => `
            <div class="notif-item">
              <div class="notif-title">${n.titulo} - 
              <span class="notif-sub">${formatarDataISO(n.data)}</span></div>
              <div style="margin-top:6px;">${n.mensagem}</div>
            </div>
          `).join("");

          const combined = (ticketHtml || sysHtml) ? (ticketHtml + sysHtml) : "<p style='text-align:center; color:#6c757d;'>Sem notifica??es</p>";
          lista.innerHTML = combined;

          const lastTs = arr.length ? Math.max(...arr.map(t => Date.parse(t.data || "") || 0)) : 0;
          marcarNotificacoesTicketsLidas(lastTs);
          if (sys.length) {
            const ultimoId = Math.max(...sys.map(x => Number(x.id) || 0));
            marcarNotificacoesSistemaLidas(ultimoId);
          }
          atualizarNotificacoesTickets();
        })
        .withFailureHandler((err) => {
          console.error(err);
          lista.innerHTML = ticketHtml || "<p style='text-align:center; color:#dc3545;'>Erro ao carregar notifica??es</p>";
          atualizarNotificacoesTickets();
        })
        .listarNotificacoesSistema();
    })
    .withFailureHandler((err) => {
      console.error(err);
      lista.innerHTML = "<p style='text-align:center; color:#dc3545;'>Erro ao carregar notifica??es</p>";
    })
    .listarTickets(Estado.usuarioAtual, Estado.isAdmin);
}

function fecharModalNotificacoes() {
  const modal = document.getElementById("modalNotificacoes");
  if (modal) modal.classList.remove("show");
}

// tabs removidas

function abrirTicketPorId(id) {
  const lista = window._ticketsLista || [];
  const t = lista.find(x => String(x.id) === String(id));
  if (t) {
    fecharModalNotificacoes();
    abrirDetalheTicket(t);
  } else {
    fecharModalNotificacoes();
    carregarTickets();
  }
}

function isTicketPendenteParaNotificacao(ticket) {
  if (!ticket) return false;
  if (Estado.isAdmin) {
    return ticket.status === "aberto" || ticket.status === "andamento";
  }
  return ticket.status === "andamento" || ticket.status === "resolvido";
}

/**
 * Renderiza a lista de tickets com filtro
 * @param {Array} tickets - Array de tickets
 * @param {string} filtro - Filtro por status
 */
function renderizarTickets(tickets, filtro, q = '') {
  const tbody = document.getElementById('corpoTabelaTickets');
  if (!tbody) {
    console.error('Tbody de tickets não encontrado');
    return;
  }

  tbody.innerHTML = "";

  // Normaliza retorno caso venha null/undefined ou embrulhado
  if (!tickets) {
    tickets = [];
  } else if (typeof tickets === 'object' && !Array.isArray(tickets)) {
    if (Array.isArray(tickets.tickets)) {
      tickets = tickets.tickets;
    }
  }

  // Valida array de tickets
  if (!Array.isArray(tickets)) {
    tbody.innerHTML = "<tr><td colspan=9 style='text-align:center; padding:24px; color:#6c757d;'>Erro ao carregar tickets</td></tr>";
    return;
  }

  // Aplica filtro por status
  let ticketsFiltrados = tickets;
  if (filtro && filtro !== 'todos') {
    ticketsFiltrados = tickets.filter(t => t.status === filtro);
  }

  // Aplica pesquisa de texto quando fornecida
  const termo = (q || '').toString().trim().toLowerCase();
  if (termo) {
    ticketsFiltrados = ticketsFiltrados.filter(t => {
      const combinado = `${t.assunto || ''} ${t.descricao || ''} ${t.usuario || ''} ${t.id || ''}`.toLowerCase();
      return combinado.indexOf(termo) !== -1;
    });
  }

  // Atualiza contagem
  const contagem = document.getElementById('contagemTickets');
  if (contagem) contagem.textContent = ticketsFiltrados.length;

  if (ticketsFiltrados.length === 0) {
    tbody.innerHTML = "<tr><td colspan=9 style='text-align:center; padding:40px; color:#6c757d;'>Nenhum ticket encontrado</td></tr>";
    return;
  }

  // Renderiza linhas da tabela
  ticketsFiltrados.forEach((ticket, index) => {
    const tr = document.createElement('tr');
    tr.onclick = () => abrirDetalheTicket(ticket);

    const tdId = document.createElement('td');
    tdId.textContent = ticket.id;

    const tdTicket = document.createElement('td');
    tdTicket.textContent = formatarCodigoTicket(ticket, index);

    const tdTipo = document.createElement('td');
    tdTipo.textContent = ticket.tipo === 'ocorrencia' ? 'Ocorrência' : 'Sugestão';

    const tdAssunto = document.createElement('td');
    tdAssunto.textContent = ticket.assunto;

    const tdPrioridade = document.createElement('td');
    tdPrioridade.textContent = ticket.prioridade === 'alta' ? 'Alta' : ticket.prioridade === 'media' ? 'Média' : 'Baixa';
    tdPrioridade.className = `ticket-prioridade ${ticket.prioridade}`;

    const tdUsuario = document.createElement('td');
    tdUsuario.textContent = ticket.usuario;

    const tdStatus = document.createElement('td');
    tdStatus.innerHTML = `<span class="ticket-status ${ticket.status}">${formatarStatus(ticket.status)}</span>`;

    const tdData = document.createElement('td');
    tdData.textContent = formatarDataISO(ticket.data);

    const tdAcoes = document.createElement('td');
    tdAcoes.className = 'table-actions';
    tdAcoes.onclick = (e) => e.stopPropagation();

    // Ações - usar select para economizar espaço
    if (Estado.isAdmin) {
      const select = document.createElement('select');
      select.className = 'form-select form-select-sm';
      select.innerHTML = `
        <option value="">Ações</option>
        <option value="andamento">Andamento</option>
        <option value="resolvido">Resolver</option>
        <option value="fechado">Fechar</option>
      `;
      select.onclick = (e) => e.stopPropagation();
      select.onchange = (e) => {
        e.stopPropagation();
        const v = select.value;
        if (v) alterarStatusTicket(ticket.id, v);
        select.value = "";
      };
      tdAcoes.appendChild(select);
    } else {
      const btnView = document.createElement('button');
      btnView.className = 'btn-sm btn-primary';
      btnView.textContent = 'Ver';
      btnView.onclick = (e) => { e.stopPropagation(); abrirDetalheTicket(ticket); };
      tdAcoes.appendChild(btnView);
    }

    tr.appendChild(tdId);
    tr.appendChild(tdTicket);
    tr.appendChild(tdTipo);
    tr.appendChild(tdAssunto);
    tr.appendChild(tdPrioridade);
    tr.appendChild(tdUsuario);
    tr.appendChild(tdStatus);
    tr.appendChild(tdData);
    tr.appendChild(tdAcoes);

    tbody.appendChild(tr);
  });
}

/**
 * Formata o nome do status para exibição
 * @param {string} status - Status interno
 * @returns {string} - Status formatado
 */
function formatarStatus(status) {
  const map = {
    'aberto': 'Aberto',
    'andamento': 'Em Andamento',
    'resolvido': 'Resolvido',
    'fechado': 'Fechado'
  };
  return map[status] || status;
}

/**
 * Formata código visual do ticket no padrão #0000
 * @param {Object} ticket
 * @param {number} index
 * @returns {string}
 */
function formatarCodigoTicket(ticket, index = 0) {
  if (ticket && ticket.codigo != null && String(ticket.codigo).trim() !== "") {
    const raw = String(ticket.codigo).trim();
    return raw.startsWith("#") ? raw : `#${String(raw).padStart(4, '0')}`;
  }
  const raw = ticket && ticket.id != null ? String(ticket.id) : '';
  const digits = raw.replace(/\D/g, '');
  let base = digits ? digits.slice(-4) : String(index + 1);
  if (!base) base = String(index + 1);
  return `#${String(base).padStart(4, '0')}`;
}

/**
 * Filtra tickets por status e recarrega
 * @param {string} filtro - Status para filtrar
 */
function filtrarTickets(filtro) {
  // Atualiza botões de filtro
  document.querySelectorAll('.btn-filtro').forEach(btn => {
    btn.classList.remove('active');
    if (btn.dataset.filtro === filtro) {
      btn.classList.add('active');
    }
  });
  // Preserva termo de busca atual
  const termo = document.getElementById('ticketsSearch') ? document.getElementById('ticketsSearch').value : '';
  carregarTickets(filtro, termo);
}

/**
 * Executa busca por termo combinada com filtro ativo
 */
function buscarTickets() {
  const termo = document.getElementById('ticketsSearch') ? document.getElementById('ticketsSearch').value : '';
  const ativo = document.querySelector('.btn-filtro.active');
  const filtro = ativo ? ativo.dataset.filtro : 'todos';
  carregarTickets(filtro, termo);
}

/**
 * Abre modal para criar novo ticket
 */
function abrirModalNovoTicket() {
  document.getElementById('formTicket').reset();
  document.getElementById('modalNovoTicket').classList.add('show');
}

/**
 * Fecha modal de novo ticket
 */
function fecharModalTicket() {
  document.getElementById('modalNovoTicket').classList.remove('show');
}

/**
 * Salva novo ticket
 * RPC: criarTicket(ticket)
 */
function salvarTicket() {
  const tipo = document.getElementById('ticketTipo').value;
  const assunto = document.getElementById('ticketAssunto').value.trim();
  const descricao = document.getElementById('ticketDescricao').value.trim();
  const prioridade = document.getElementById('ticketPrioridade').value;
  
  if (!assunto || !descricao) {
    mostrarToast("Preencha todos os campos obrigatórios.", "warning");
    return;
  }
  
  const ticket = {
    tipo,
    assunto,
    descricao,
    prioridade,
    usuario: Estado.usuarioAtual,
    status: 'aberto',
    data: new Date().toISOString()
  };
  
  Loading.show("Enviando ticket...");
  
  google.script.run
    .withSuccessHandler((res) => {
      Loading.hide();
      
      if (res.status === "ok") {
        mostrarToast("Ticket criado com sucesso!", "success");
        fecharModalTicket();
        carregarTickets();  // Recarrega lista
        atualizarNotificacoesTickets();
        if (typeof touchSessao === "function") {
          touchSessao();
        }
      } else {
        mostrarToast(res.msg || "Erro ao criar ticket.", "error");
      }
    })
    .withFailureHandler((err) => {
      Loading.hide();
      console.error(err);
      mostrarToast("Erro ao criar ticket.", "error");
    })
    .criarTicket(ticket);
}

/**
 * Abre modal com detalhes completos do ticket
 * @param {Object} ticket - Dados do ticket
 */
function abrirDetalheTicket(ticket) {
  const modal = document.createElement('div');
  modal.className = 'modal show';
  modal.innerHTML = `
    <div class="modal-content modal-large">
      <div class="modal-header">
        <h3><i class="material-symbols-outlined">support</i> Ticket ${formatarCodigoTicket(ticket, 0)}</h3>
        <span class="modal-close" onclick="this.closest('.modal').remove()">&times;</span>
      </div>
      <div class="modal-body">
        <div class="ticket-detail">
          <div class="ticket-info-grid">
            <div><strong>Tipo:</strong> ${ticket.tipo === 'ocorrencia' ? 'Ocorrência' : 'Sugestão'}</div>
            <div><strong>Status:</strong> <span class="ticket-status ${ticket.status}">${formatarStatus(ticket.status)}</span></div>
            <div><strong>Prioridade:</strong> ${ticket.prioridade}</div>
            <div><strong>Usuário:</strong> ${ticket.usuario}</div>
            <div><strong>Data:</strong> ${formatarDataISO(ticket.data)}</div>
          </div>
          
          <div class="ticket-content">
            <h4>${ticket.assunto}</h4>
            <p>${ticket.descricao}</p>
          </div>
          
          <div class="ticket-historico">
            <h4><i class="material-symbols-outlined">history</i> Histórico de Conversas</h4>
            <div id="historicoTicket${ticket.id}">
              <p style="text-align: center; color: #6c757d; padding: 20px;">Carregando histórico...</p>
            </div>
          </div>
          
          <div class="ticket-resposta">
            <h4>Adicionar Comentário</h4>
            <textarea id="comentarioTicket" class="form-control" rows="3" placeholder="Digite seu comentário..."></textarea>
            <button class="btn-primary" style="margin-top: 10px;" onclick="adicionarComentario('${ticket.id}')">
              <i class="material-symbols-outlined">send</i> Enviar
            </button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="this.closest('.modal').remove()">Fechar</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
  
  // Carrega histórico de comentários
  carregarHistoricoTicket(ticket.id);
}

/**
 * Carrega histórico de comentários do ticket
 * RPC: listarComentariosTicket(ticketId)
 * 
 * @param {string} ticketId - ID do ticket
 */
function carregarHistoricoTicket(ticketId) {
  Loading.show("Carregando histórico...");
  
  google.script.run
    .withSuccessHandler((comentarios) => {
      Loading.hide();
      const container = document.getElementById(`historicoTicket${ticketId}`);
      if (!container) return;
      
      if (!comentarios || comentarios.length === 0) {
        container.innerHTML = "<p style='text-align: center; color: #6c757d;'>Nenhum comentário ainda</p>";
        return;
      }
      
      // Renderiza comentários
      container.innerHTML = comentarios.map(c => `
        <div class="comentario-item">
          <div class="comentario-header">
            <strong>${c.usuario}</strong>
            <span>${formatarDataISO(c.data)}</span>
          </div>
          <p>${c.texto}</p>
        </div>
      `).join('');
      if (typeof atualizarNotificacoesTickets === "function") {
        atualizarNotificacoesTickets();
      }
      if (typeof touchSessao === "function") {
        touchSessao();
      }
    })
    .withFailureHandler((err) => {
      Loading.hide();
      console.error(err);
      const container = document.getElementById(`historicoTicket${ticketId}`);
      if (container) {
        container.innerHTML = "<p style='text-align: center; color: #dc3545;'>Erro ao carregar histórico</p>";
      }
    })
    .listarComentariosTicket(ticketId);
}

/**
 * Adiciona comentário a um ticket
 * RPC: adicionarComentarioTicket(ticketId, comentario)
 * 
 * @param {string} ticketId - ID do ticket
 */
function adicionarComentario(ticketId) {
  const textarea = document.getElementById('comentarioTicket');
  const texto = textarea?.value.trim();
  
  if (!texto) {
    mostrarToast("Digite um comentário", "warning");
    return;
  }
  
  Loading.show("Enviando comentário...");
  
  google.script.run
    .withSuccessHandler((res) => {
      Loading.hide();
      if (res.status === "ok") {
        mostrarToast("Comentário adicionado!", "success");
        textarea.value = "";
        carregarHistoricoTicket(ticketId);  // Recarrega histórico
        if (typeof touchSessao === "function") {
          touchSessao();
        }
      } else {
        mostrarToast(res.msg || "Erro ao adicionar comentário", "error");
      }
    })
    .withFailureHandler((err) => {
      Loading.hide();
      console.error(err);
      mostrarToast("Erro ao adicionar comentário", "error");
    })
    .adicionarComentarioTicket(ticketId, {
      usuario: Estado.usuarioAtual,
      texto: texto,
      data: new Date().toISOString()
    });
}

/**
 * Altera status de um ticket (somente admin)
 * RPC: atualizarStatusTicket(id, novoStatus)
 * 
 * @param {string} id - ID do ticket
 * @param {string} novoStatus - Novo status
 */
function alterarStatusTicket(id, novoStatus) {
  Loading.show("Atualizando status...");
  
  google.script.run
    .withSuccessHandler((res) => {
      Loading.hide();
      
      if (res.status === "ok") {
        mostrarToast("Status atualizado!", "success");
        carregarTickets();  // Recarrega lista
        atualizarNotificacoesTickets();
        if (typeof touchSessao === "function") {
          touchSessao();
        }
      } else {
        mostrarToast(res.msg || "Erro ao atualizar status.", "error");
      }
    })
    .withFailureHandler((err) => {
      Loading.hide();
      console.error(err);
      mostrarToast("Erro ao atualizar status.", "error");
    })
    .atualizarStatusTicket(id, novoStatus);
}


</script>

